name: CodeQL with US Runner

on: [push, pull_request]

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.internal.http.connectionTimeout=60000 -Dorg.gradle.internal.http.socketTimeout=60000"
      MAVEN_OPTS: "-Dmaven.wagon.http.retryHandler.count=3"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'zulu'
    
    - name: Network Pre-check
      run: |
        echo "test connect..."
        
        timeout 10 curl -s https://plugins.gradle.org/m2/ >/dev/null && echo "✓ Gradle Plugin Portal OK" || echo "✗ Gradle Plugin Portal Failed"
        timeout 10 curl -s https://dl.google.com/dl/android/maven2/ >/dev/null && echo "✓ Google Maven OK" || echo "✗ Google Maven Failed"
        timeout 10 curl -s https://repo.maven.apache.org/maven2/ >/dev/null && echo "✓ Maven Central OK" || echo "✗ Maven Central Failed"
        
        echo "实际IP地址：$(curl -s ifconfig.me)"
        echo "IP地理位置：$(curl -s ipinfo.io/city), $(curl -s ipinfo.io/country)"
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java
        build-mode: manual
        queries: security-and-quality
    
    - name: Build with Retry
      run: |
        MAX_RETRY=3
        RETRY_DELAY=10
        
        for i in $(seq 1 $MAX_RETRY); do
          echo "构建尝试 $i/$MAX_RETRY"
          
          if [ $i -eq 1 ]; then
            COMMAND="./gradlew compileJava --no-daemon --build-cache"
          elif [ $i -eq 2 ]; then
            COMMAND="./gradlew compileJava --no-daemon --offline || true"
          else
            COMMAND="find . -name '*.java' | head -20 | xargs javac -cp . -d /tmp/classes 2>/dev/null || true"
          fi
          
          if eval $COMMAND; then
            echo "构建成功"
            exit 0
          fi
          
          echo "构建失败，${RETRY_DELAY}秒后重试..."
          sleep $RETRY_DELAY
        done
        
        echo "所有尝试失败，继续执行CodeQL分析..."
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      continue-on-error: true
