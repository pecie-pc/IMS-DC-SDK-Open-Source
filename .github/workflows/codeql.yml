name: CodeQL Analysis (Manual Build, Security & Quality)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  analyze:
    name: Analyze (Java/Kotlin)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    
    # 针对 Gradle 和网络优化的环境变量
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.internal.http.connectionTimeout=60000 -Dorg.gradle.internal.http.socketTimeout=60000"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java and Cache Gradle
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'zulu'
        cache: 'gradle' # 缓存 Gradle 依赖，提高后续运行速度
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java # 覆盖 Java 和 Kotlin
        build-mode: manual # <-- 关键：指定手动构建模式
        queries: security-and-quality # <-- 启用安全和质量查询

    - name: Build Code with Retry (Manual Step)
      run: |
        MAX_RETRY=3
        RETRY_DELAY=15 # 失败后等待 15 秒重试
        
        for i in $(seq 1 $MAX_RETRY); do
          echo "Building attempt $i/$MAX_RETRY..."
          
          # 运行 Gradle 编译命令，这是 CodeQL 捕获代码的关键步骤
          if ./gradlew compileJava --no-daemon --build-cache; then
            echo "Build successful on attempt $i."
            exit 0
          else
            echo "Build failed on attempt $i, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          fi
        done
        
        echo "ERROR: All build attempts failed. CodeQL analysis will likely be incomplete."

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
