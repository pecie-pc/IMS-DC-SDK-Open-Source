name: CodeQL Analysis (Manual Build, Security & Quality)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # æ‚¨ä¹Ÿå¯ä»¥æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œä¾‹å¦‚æ¯å‘¨ä¸‰ä¸­åˆè¿è¡Œ
  # schedule:
  #   - cron: '37 12 * * 3'

jobs:
  analyze:
    name: Analyze (Java/Kotlin)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    
    # é’ˆå¯¹ Gradle å’Œç½‘ç»œä¼˜åŒ–çš„ç¯å¢ƒå˜é‡
    env:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.internal.http.connectionTimeout=60000 -Dorg.gradle.internal.http.socketTimeout=60000"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java and Cache Gradle
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'zulu'
        cache: 'gradle' # ç¼“å­˜ Gradle ä¾èµ–ï¼Œæé«˜åç»­è¿è¡Œé€Ÿåº¦
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java # è¦†ç›– Java å’Œ Kotlin
        build-mode: manual # <-- å…³é”®ï¼šæŒ‡å®šæ‰‹åŠ¨æ„å»ºæ¨¡å¼
        # å¯ç”¨å®‰å…¨æ‰©å±•å’Œæ‰€æœ‰ä»£ç è´¨é‡æŸ¥è¯¢
        queries: security-and-quality

    - name: Build Code with Retry (Manual Step)
      run: |
        MAX_RETRY=3
        RETRY_DELAY=15 # å¤±è´¥åç­‰å¾… 15 ç§’é‡è¯•
        
        for i in $(seq 1 $MAX_RETRY); do
          echo "Building attempt $i/$MAX_RETRY..."
          
          # ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨å…·ä½“çš„ Gradle ä»»åŠ¡ assembleDebug
          COMMAND="./gradlew compileNormalDebugJavaWithJavac --no-daemon --build-cache"
          
          if eval "$COMMAND"; then
            echo "Build successful on attempt $i."
            exit 0
          fi
          
          echo "Build failed on attempt $i, retrying in ${RETRY_DELAY}s..."
          sleep $RETRY_DELAY
        done
        
        echo "ERROR: All build attempts failed. CodeQL analysis will likely be incomplete."
        # å¦‚æœæ„å»ºæœ€ç»ˆå¤±è´¥ï¼Œå·¥ä½œæµå°†åœ¨æ­¤æ­¥éª¤æ ‡è®°å¤±è´¥çŠ¶æ€ã€‚

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      # continue-on-error é»˜è®¤æ˜¯ falseï¼Œè¿™æ˜¯æœ€å¥½çš„åšæ³•ã€‚
